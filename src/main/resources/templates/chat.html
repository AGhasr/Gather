<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Group Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body class="bg-body overflow-hidden"> <div th:replace="fragments/navbar :: navbar"></div>

<div class="container py-4 chat-layout">
    <div class="row justify-content-center h-100">
        <div class="col-md-10 col-lg-8 h-100">

            <div class="chat-card">
                <div class="chat-header d-flex justify-content-between align-items-center shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary-soft text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                            <i class="fas fa-users fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold">Squad Chat</h5>
                            <small class="text-muted text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Live</small>
                        </div>
                    </div>
                    <a href="/groups" class="btn btn-light btn-sm rounded-pill px-3">
                        <i class="fas fa-arrow-left me-1"></i> Exit
                    </a>
                </div>

                <div id="chat-box" class="chat-body-scroll">
                    <input type="hidden" id="groupId" th:value="${groupId}">
                    <input type="hidden" id="username" th:value="${#authentication.name}">

                    <div th:if="${#lists.isEmpty(history)}" id="empty-msg" class="text-center mt-5 opacity-50">
                        <i class="far fa-comments fa-3x mb-3 text-muted"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>

                    <div th:each="msg : ${history}"
                         class="message-row"
                         th:classappend="${msg.sender == #authentication.name} ? 'mine' : 'other'">

                        <div class="message-content-wrapper">
                            <span class="sender-label ms-1" th:if="${msg.sender != #authentication.name}" th:text="${msg.sender}"></span>
                            <div class="message-bubble">
                                <span th:text="${msg.content}"></span>
                            </div>
                            <small class="text-muted ms-1 mt-1 d-block" style="font-size: 0.65rem;" th:text="${msg.formattedTime}"></small>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control form-control-lg chat-input" placeholder="Type a message..." autocomplete="off">
                        <button class="btn btn-primary px-4 ms-2 rounded-pill" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    var stompClient = null;
    var groupId = document.getElementById('groupId').value;
    var username = document.getElementById('username').value;
    var chatBox = document.getElementById('chat-box');

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/group/' + groupId, function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
            scrollToBottom();
        });
    }

    function sendMessage() {
        var messageInput = document.getElementById('message-input');
        var messageContent = messageInput.value.trim();

        if(messageContent && stompClient) {
            var chatMessage = {
                sender: username,
                content: messageContent,
                groupId: groupId,
                type: 'CHAT'
            };
            stompClient.send("/app/chat/" + groupId, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    function showMessage(message) {
        var emptyMsg = document.getElementById('empty-msg');
        if (emptyMsg) emptyMsg.remove();

        var messageRow = document.createElement('div');
        messageRow.classList.add('message-row');

        var isMine = (message.sender === username);
        if (isMine) {
            messageRow.classList.add('mine');
        } else {
            messageRow.classList.add('other');
        }

        // Current time short format
        var timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        var contentHtml = '<div class="message-content-wrapper">';

        if (!isMine) {
            contentHtml += `<span class="sender-label ms-1">${message.sender}</span>`;
        }

        contentHtml += `
            <div class="message-bubble">
                <span>${message.content}</span>
            </div>
            <small class="text-muted ms-1 mt-1 d-block" style="font-size: 0.65rem;">${timeStr}</small>
        </div>`;

        messageRow.innerHTML = contentHtml;
        chatBox.appendChild(messageRow);
        scrollToBottom();
    }

    window.onload = connect;

    document.getElementById("message-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });
</script>

</body>
</html>